<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政策関連情報の一覧（政策リサーチ）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sort-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Style for the currently playing audio button */
        .play-btn.playing {
            background-color: #f59e0b; /* amber-500 */
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        /* Style for delete confirmation */
        .delete-btn.delete-confirm {
            background-color: #f97316; /* orange-500 */
        }
        /* Pagination styles */
        .page-btn.active {
            z-index: 10;
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600 dark:text-indigo-400">政策関連情報の一覧（政策リサーチ）</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">タイトル名に関連するWEBサイトやPDFデータ、音声解説にアクセス</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500"></div>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button id="tab-register-btn" class="tab-btn active px-4 py-3 text-sm font-medium text-center rounded-t-lg">
                    登録
                </button>
                <button id="tab-list-btn" class="tab-btn px-4 py-3 text-sm font-medium text-center rounded-t-lg">
                    一覧
                </button>
                <button id="tab-list-readonly-btn" class="tab-btn px-4 py-3 text-sm font-medium text-center rounded-t-lg">
                    データ一覧
                </button>
                 <button id="tab-edit-btn" class="tab-btn hidden px-4 py-3 text-sm font-medium text-center rounded-t-lg">
                    修正
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Registration View -->
            <div id="view-register">
                <!-- Single Item Registration -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">新規データ登録</h2>
                    <form id="register-form" class="space-y-6">
                        <div>
                            <label for="reg-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">日付</label>
                            <input type="date" id="reg-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div>
                            <label for="reg-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">タイトル</label>
                            <input type="text" id="reg-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="タイトルを入力" required>
                        </div>
                        <div>
                            <label for="reg-url1" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">URL1 (音声)</label>
                            <input type="url" id="reg-url1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="https://example.com/audio.mp3">
                        </div>
                        <div>
                            <label for="reg-url2" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">URL2 (参考)</label>
                            <input type="url" id="reg-url2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="https://example.com/reference">
                        </div>
                        <div>
                            <label for="reg-remarks" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">備考</label>
                            <textarea id="reg-remarks" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="備考を記入..."></textarea>
                        </div>
                        <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800">登録する</button>
                    </form>
                </div>
                <!-- Bulk Registration -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mt-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Excelファイルで一括登録</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        以下の形式のExcelファイル(.xlsx)をアップロードしてください。<br>
                        - 1行目はヘッダー行として無視されます。<br>
                        - A列:日付, B列:タイトル, C列:URL1(音声), D列:URL2(参考), E列:備考
                    </p>
                    <div class="space-y-4">
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
                        <button id="bulk-register-btn" class="w-full text-white bg-teal-600 hover:bg-teal-700 focus:ring-4 focus:outline-none focus:ring-teal-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-teal-600 dark:hover:bg-teal-700 dark:focus:ring-teal-800 disabled:opacity-50">一括登録する</button>
                    </div>
                    <div id="bulk-upload-status" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- List View (Editable) -->
            <div id="view-list" class="hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <h2 id="list-title-editable" class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">登録データ一覧（編集可）</h2>
                     <div id="controls-editable" class="controls-panel"></div>
                     <div id="item-list-editable" class="space-y-4 mt-6"></div>
                     <div id="pagination-editable" class="mt-6"></div>
                 </div>
            </div>
            
            <!-- List View (Read-Only) -->
            <div id="view-list-readonly" class="hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <h2 id="list-title-readonly" class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">データ一覧</h2>
                     <div id="controls-readonly" class="controls-panel"></div>
                     <div id="item-list-readonly" class="space-y-4 mt-6"></div>
                     <div id="pagination-readonly" class="mt-6"></div>
                 </div>
            </div>

            <!-- Edit View -->
            <div id="view-edit" class="hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-white">データ修正</h2>
                    <form id="edit-form" class="space-y-6">
                        <input type="hidden" id="edit-doc-id">
                        <div>
                            <label for="edit-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">日付</label>
                            <input type="date" id="edit-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div>
                            <label for="edit-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">タイトル</label>
                            <input type="text" id="edit-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div>
                            <label for="edit-url1" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">URL1 (音声)</label>
                            <input type="url" id="edit-url1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        </div>
                        <div>
                            <label for="edit-url2" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">URL2 (参考)</label>
                            <input type="url" id="edit-url2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        </div>
                        <div>
                            <label for="edit-remarks" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">備考</label>
                            <textarea id="edit-remarks" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></textarea>
                        </div>
                        <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">更新する</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DO NOT EDIT ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'data-management-app';
        // --- END DO NOT EDIT ---
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let itemsCollectionRef = null;
        let unsubscribe = null;
        let currentAudio = null;
        let allItems = [];
        
        // State Management
        let searchTerm = '';
        let sortConfig = { key: 'date', direction: 'desc' };
        let pagination = { editable: { currentPage: 1 }, readonly: { currentPage: 1 } };
        const ITEMS_PER_PAGE = 50;

        // DOM Elements
        const tabRegisterBtn = document.getElementById('tab-register-btn');
        const tabListBtn = document.getElementById('tab-list-btn');
        const tabListReadonlyBtn = document.getElementById('tab-list-readonly-btn');
        const tabEditBtn = document.getElementById('tab-edit-btn');
        const viewRegister = document.getElementById('view-register');
        const viewList = document.getElementById('view-list');
        const viewListReadonly = document.getElementById('view-list-readonly');
        const viewEdit = document.getElementById('view-edit');
        const registerForm = document.getElementById('register-form');
        const editForm = document.getElementById('edit-form');
        const itemListEditableContainer = document.getElementById('item-list-editable');
        const itemListReadonlyContainer = document.getElementById('item-list-readonly');
        const userInfoDiv = document.getElementById('user-info');
        const excelFileInput = document.getElementById('excel-file-input');
        const bulkRegisterBtn = document.getElementById('bulk-register-btn');
        const bulkUploadStatus = document.getElementById('bulk-upload-status');
        const controlsEditableContainer = document.getElementById('controls-editable');
        const controlsReadonlyContainer = document.getElementById('controls-readonly');
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                userInfoDiv.style.display = 'none';
                itemsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/items`);
                listenForItems();
            } else {
                userId = null;
                allItems = [];
                userInfoDiv.textContent = '認証待機中...';
                userInfoDiv.style.display = 'block';
                if (unsubscribe) unsubscribe();
                renderAllLists([]);
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed: ", error);
                userInfoDiv.textContent = '認証に失敗しました。';
            }
        })();

        // --- UI Initialization and Event Listeners ---
        function createControlsHTML(idPrefix) {
            return `
                <div class="p-4 bg-gray-100 dark:bg-gray-900/50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <label for="search-input-${idPrefix}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">キーワード検索 (タイトル, 備考, PDF, WEB)</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="search-input-${idPrefix}" class="search-input flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="検索キーワード...">
                                <button type="button" class="search-clear-btn -ml-px relative inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-700 bg-gray-50 hover:bg-gray-100 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 dark:border-gray-600">解除</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">並び替え</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <button type="button" class="sort-btn px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500" data-sort-key="date">日付順 <span class="sort-indicator"></span></button>
                                <button type="button" class="sort-btn px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500" data-sort-key="title">タイトル順 <span class="sort-indicator"></span></button>
                                <button type="button" class="sort-reset-btn px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-200">リセット</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        controlsEditableContainer.innerHTML = createControlsHTML('editable');
        controlsReadonlyContainer.innerHTML = createControlsHTML('readonly');

        function setupControlListeners(panelId) {
            const panel = document.getElementById(panelId);
            panel.querySelector('.search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                document.querySelectorAll('.search-input').forEach(el => el.value = searchTerm);
                pagination.editable.currentPage = 1;
                pagination.readonly.currentPage = 1;
                updateAndRender();
            });
            panel.querySelector('.search-clear-btn').addEventListener('click', () => {
                searchTerm = '';
                document.querySelectorAll('.search-input').forEach(el => el.value = '');
                updateAndRender();
            });
            panel.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.sortKey;
                    if (sortConfig.key === key) {
                        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortConfig.key = key;
                        sortConfig.direction = key === 'date' ? 'desc' : 'asc';
                    }
                    pagination.editable.currentPage = 1;
                    pagination.readonly.currentPage = 1;
                    updateAndRender();
                });
            });
            panel.querySelector('.sort-reset-btn').addEventListener('click', () => {
                sortConfig = { key: 'date', direction: 'desc' };
                updateAndRender();
            });
        }
        setupControlListeners('controls-editable');
        setupControlListeners('controls-readonly');

        // --- Tab Management ---
        function switchTab(activeView, activeBtn) {
            [viewRegister, viewList, viewListReadonly, viewEdit].forEach(view => view.classList.add('hidden'));
            [tabRegisterBtn, tabListBtn, tabListReadonlyBtn, tabEditBtn].forEach(btn => btn.classList.remove('active'));
            activeView.classList.remove('hidden');
            activeBtn.classList.add('active');
            tabEditBtn.classList.toggle('hidden', activeView !== viewEdit);
            if(activeView !== viewRegister && activeView !== viewEdit) updateAndRender();
        }
        tabRegisterBtn.addEventListener('click', () => switchTab(viewRegister, tabRegisterBtn));
        tabListBtn.addEventListener('click', () => switchTab(viewList, tabListBtn));
        tabListReadonlyBtn.addEventListener('click', () => switchTab(viewListReadonly, tabListReadonlyBtn));
        
        // --- Data Fetching and Rendering ---
        function listenForItems() {
            if (unsubscribe) unsubscribe();
            if (!itemsCollectionRef) return;
            unsubscribe = onSnapshot(itemsCollectionRef, (querySnapshot) => {
                allItems = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAndRender();
            }, (error) => {
                console.error("Error fetching items: ", error);
                renderAllLists([], '<p class="text-red-500">データの読み込み中にエラーが発生しました。</p>');
            });
        }
        
        function updateAndRender() {
            let processedItems = [...allItems];
            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                processedItems = processedItems.filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(lowerCaseSearchTerm);
                    const remarksMatch = (item.remarks || '').toLowerCase().includes(lowerCaseSearchTerm);
                    
                    let typeMatch = false;
                    const hasLink = item.url2 && item.url2.trim() !== '';
                    if (hasLink) {
                        const isPdf = item.url2.toLowerCase().includes('.pdf');
                        if (isPdf && 'pdf'.includes(lowerCaseSearchTerm)) {
                            typeMatch = true;
                        } else if (!isPdf && 'web'.includes(lowerCaseSearchTerm)) {
                            typeMatch = true;
                        }
                    }
                    return titleMatch || remarksMatch || typeMatch;
                });
            }
            
            processedItems.sort((a, b) => {
                const valA = a[sortConfig.key] || '';
                const valB = b[sortConfig.key] || '';
                if (sortConfig.key === 'date') {
                    return sortConfig.direction === 'desc' ? new Date(valB) - new Date(valA) : new Date(valA) - new Date(valB);
                }
                const comparison = valA.localeCompare(valB, 'ja');
                return sortConfig.direction === 'asc' ? comparison : -comparison;
            });

            document.getElementById('list-title-editable').textContent = `登録データ一覧（編集可） (全${allItems.length}件中 ${processedItems.length}件表示)`;
            document.getElementById('list-title-readonly').textContent = `データ一覧 (全${allItems.length}件中 ${processedItems.length}件表示)`;

            renderAllLists(processedItems);
            updateSortIndicators();
        }

        function renderAllLists(items) {
            renderPaginatedList('editable', items);
            renderPaginatedList('readonly', items);
        }

        function renderPaginatedList(type, items) {
            const container = type === 'editable' ? itemListEditableContainer : itemListReadonlyContainer;
            const paginationContainer = document.getElementById(`pagination-${type}`);
            const currentPage = pagination[type].currentPage;
            
            container.innerHTML = '';
            paginationContainer.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">データがありません。</p>';
                return;
            }

            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages) {
                pagination[type].currentPage = totalPages > 0 ? totalPages : 1;
            }
            const start = (pagination[type].currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = items.slice(start, end);
            
            pageItems.forEach(item => container.appendChild(createItemElement(item, type === 'readonly')));
            renderPagination(paginationContainer, totalPages, pagination[type].currentPage, type);
        }

        function renderPagination(container, totalPages, currentPage, type) {
            if (totalPages <= 1) return;
            let paginationHTML = `
                <nav class="flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
                    <div class="flex-1 flex justify-between sm:justify-end">`;
            if (currentPage > 1) {
                paginationHTML += `<a href="#" class="page-link relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" data-page="${currentPage - 1}" data-type="${type}">前へ</a>`;
            } else {
                 paginationHTML += `<div></div>`;
            }
            if (currentPage < totalPages) {
                paginationHTML += `<a href="#" class="page-link relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" data-page="${currentPage + 1}" data-type="${type}">次へ</a>`;
            }
            paginationHTML += `</div></nav>`;
            container.innerHTML = paginationHTML;
        }

        function createItemElement(item, isReadOnly) {
            const itemEl = document.createElement('div');
            itemEl.className = 'item-element bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-gray-600 flex flex-col sm:flex-row items-center justify-between gap-4';
            itemEl.dataset.itemId = item.id;

            const shortRemarks = item.remarks && item.remarks.length > 50 ? item.remarks.substring(0, 47) + '...' : item.remarks;
            const hasLink = item.url2 && item.url2.trim() !== '';
            const titleElement = hasLink ? `<a href="${item.url2}" target="_blank" rel="noopener noreferrer" class="text-xl font-bold text-indigo-500 hover:text-indigo-700 hover:underline dark:hover:text-indigo-300">${item.title}</a>` : `<span class="text-xl font-bold text-indigo-500">${item.title}</span>`;
            
            let remarksHTML = '';
            if (item.remarks) {
                let label = `<strong>備考:</strong>`;
                if (hasLink) {
                    label = item.url2.toLowerCase().includes('.pdf') ? `<strong class="text-orange-600 dark:text-orange-400">PDF:</strong>` : `<strong class="text-green-600 dark:text-green-400">WEB:</strong>`;
                }
                remarksHTML = `<p class="text-sm text-gray-600 dark:text-gray-300 mt-2">${label} ${shortRemarks}</p>`;
            }
            
            const hasAudio = item.url1 && item.url1.trim() !== '';
            const playButtonHTML = `<button data-id="${item.id}" data-url="${item.url1 || ''}" class="play-btn p-2 rounded-full ${hasAudio ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-400 text-white cursor-not-allowed'}" ${hasAudio ? '' : 'disabled'}><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg></button>`;
            
            const editButtonsHTML = isReadOnly ? '' : `
                <button data-id="${item.id}" class="edit-btn p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                <button data-id="${item.id}" class="delete-btn p-2 rounded-full bg-red-500 text-white hover:bg-red-600"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
            `;

            itemEl.innerHTML = `
                <div class="flex-grow pr-4">
                    ${titleElement}
                    ${remarksHTML}
                </div>
                <div class="flex-shrink-0 flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        ${playButtonHTML}
                        ${editButtonsHTML}
                    </div>
                    <span class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">${item.date}</span>
                </div>`;
            return itemEl;
        }

        function updateSortIndicators() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                const key = btn.dataset.sortKey;
                const indicator = btn.querySelector('.sort-indicator');
                btn.classList.toggle('active', sortConfig.key === key);
                indicator.textContent = sortConfig.key === key ? (sortConfig.direction === 'asc' ? '▲' : '▼') : '';
            });
        }
        
        function handleItemClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            e.stopPropagation();
            const docId = button.dataset.id;
            if (button.classList.contains('play-btn')) playAudio(button);
            else if (button.classList.contains('edit-btn')) showEditForm(docId);
            else if (button.classList.contains('delete-btn')) {
                if (button.classList.contains('delete-confirm')) {
                    deleteItem(docId);
                } else {
                    document.querySelectorAll('.delete-btn.delete-confirm').forEach(b => b.classList.remove('delete-confirm'));
                    button.classList.add('delete-confirm');
                }
            }
        }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.delete-btn')) {
                document.querySelectorAll('.delete-btn.delete-confirm').forEach(btn => {
                    btn.classList.remove('delete-confirm');
                });
            }
        });
        
        itemListEditableContainer.addEventListener('click', handleItemClick);
        itemListReadonlyContainer.addEventListener('click', handleItemClick);
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('reg-title').value.trim();
            if (!title) { alert("タイトルは必須です。"); return; }
            const isDuplicate = allItems.some(item => item.title.trim().toLowerCase() === title.toLowerCase());
            if(isDuplicate){ alert("同じタイトルが既に登録されています。"); return; }
            const url1 = document.getElementById('reg-url1').value.trim();
            const url2 = document.getElementById('reg-url2').value.trim();
            if (!url1 && !url2) { alert("URL1かURL2のどちらか一方は必須です。"); return; }
            if (!itemsCollectionRef) { alert("データベースに接続されていません。"); return; }
            try {
                await addDoc(itemsCollectionRef, {
                    date: document.getElementById('reg-date').value, title, url1, url2,
                    remarks: document.getElementById('reg-remarks').value,
                    createdAt: serverTimestamp()
                });
                registerForm.reset();
                switchTab(viewList, tabListBtn);
            } catch (error) { console.error("Error adding document: ", error); alert("データの登録に失敗しました。"); }
        });

        function deleteItem(docId) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/items`, docId);
            deleteDoc(docRef).catch(error => { console.error("Error removing document: ", error); alert("データの削除に失敗しました。"); });
        }
        
        async function showEditForm(docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/items`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('edit-doc-id').value = docId;
                    document.getElementById('edit-date').value = data.date;
                    document.getElementById('edit-title').value = data.title;
                    document.getElementById('edit-url1').value = data.url1 || '';
                    document.getElementById('edit-url2').value = data.url2 || '';
                    document.getElementById('edit-remarks').value = data.remarks || '';
                    switchTab(viewEdit, tabEditBtn);
                } else { alert("編集するデータが見つかりません。"); }
            } catch (error) { console.error("Error getting document for edit:", error); alert("データの読み込みに失敗しました。"); }
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('edit-doc-id').value;
            const title = document.getElementById('edit-title').value.trim();
            if (!title) { alert("タイトルは必須です。"); return; }
            const isDuplicate = allItems.some(item => item.id !== docId && item.title.trim().toLowerCase() === title.toLowerCase());
            if(isDuplicate){ alert("同じタイトルが他のデータで既に登録されています。"); return; }
            const url1 = document.getElementById('edit-url1').value.trim();
            const url2 = document.getElementById('edit-url2').value.trim();
            if (!url1 && !url2) { alert("URL1かURL2のどちらか一方は必須です。"); return; }
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/items`, docId);
            try {
                await updateDoc(docRef, {
                    date: document.getElementById('edit-date').value, title, url1, url2,
                    remarks: document.getElementById('edit-remarks').value,
                });
                switchTab(viewList, tabListBtn);
            } catch(error) { console.error("Error updating document:", error); alert("データの更新に失敗しました。"); }
        });
        
        function playAudio(clickedButton) {
            const url = clickedButton.dataset.url;
            if (!url) return;
            const isPlaying = clickedButton.classList.contains('playing');
            document.querySelectorAll('.play-btn.playing').forEach(btn => btn.classList.remove('playing'));
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.remove();
            }
            if (isPlaying) {
                currentAudio = null;
                return;
            }
            currentAudio = new Audio(url);
            clickedButton.classList.add('playing');
            currentAudio.play().catch(error => {
                console.error("Audio playback failed:", error);
                alert(`音声の再生に失敗しました: ${error.message}`);
                clickedButton.classList.remove('playing');
            });
            const stopPlayback = () => {
                clickedButton.classList.remove('playing');
                if (currentAudio) {
                    currentAudio.onended = null;
                    currentAudio.onpause = null;
                }
            };
            currentAudio.onended = stopPlayback;
            currentAudio.onpause = stopPlayback;
        }
        
        document.getElementById('reg-date').valueAsDate = new Date();

        bulkRegisterBtn.addEventListener('click', handleBulkUpload);
        function handleBulkUpload() {
            const file = excelFileInput.files[0];
            if (!file) { alert("Excelファイルを選択してください。"); return; }
            if (!itemsCollectionRef) { alert("データベースに接続されていません。"); return; }
            bulkRegisterBtn.disabled = true;
            bulkUploadStatus.textContent = "処理中...";
            bulkUploadStatus.className = "mt-4 text-sm text-blue-600";
            const reader = new FileReader();
            reader.onload = async (e) => {
                let processedCount = 0, skippedCount = 0;
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (json.length < 2) { throw new Error("ファイルに登録するデータがありません。"); }
                    const existingTitles = new Set(allItems.map(item => item.title.trim().toLowerCase()));
                    const itemsToUpload = [];
                    const titlesInBatch = new Set();
                    for(const row of json.slice(1)) {
                        const title = (row[1] || '').toString().trim();
                        const lowerCaseTitle = title.toLowerCase();
                        const url1 = (row[2] || '').toString().trim();
                        const url2 = (row[3] || '').toString().trim();
                        const isValid = (row[0] || '') && title && (url1 || url2);
                        const isDuplicate = existingTitles.has(lowerCaseTitle) || titlesInBatch.has(lowerCaseTitle);
                        if (isValid && !isDuplicate) {
                            itemsToUpload.push({
                                date: excelDateToYYYYMMDD(row[0]), title, url1, url2,
                                remarks: (row[4] || '').toString().trim(),
                                createdAt: serverTimestamp()
                            });
                            titlesInBatch.add(lowerCaseTitle);
                        } else {
                            skippedCount++;
                        }
                    }
                    if (itemsToUpload.length === 0) { throw new Error("有効で、かつ重複しないデータがありませんでした。"); }
                    const batch = writeBatch(db);
                    itemsToUpload.forEach(item => batch.set(doc(itemsCollectionRef), item));
                    await batch.commit();
                    processedCount = itemsToUpload.length;
                    bulkUploadStatus.textContent = `${processedCount}件を登録し、${skippedCount}件をスキップしました。`;
                    bulkUploadStatus.className = "mt-4 text-sm text-green-600";
                    excelFileInput.value = '';
                    switchTab(viewList, tabListBtn);
                } catch (error) {
                    console.error("Bulk upload failed:", error);
                    bulkUploadStatus.textContent = `エラー: ${error.message}`;
                    bulkUploadStatus.className = "mt-4 text-sm text-red-600";
                } finally {
                    bulkRegisterBtn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        function excelDateToYYYYMMDD(serial) {
            if(typeof serial === 'string' && serial.match(/^\d{4}-\d{2}-\d{2}$/)) return serial;
            if (typeof serial !== 'number' || serial <= 0) return '';
            const utc_days  = Math.floor(serial - 25569);
            const date_info = new Date(utc_days * 86400 * 1000);
            return new Date(date_info.getTime() + (date_info.getTimezoneOffset()*60*1000)).toISOString().split('T')[0];
        }

        updateAndRender(); // Initial render
    </script>
</body>
</html>
